# План рефакторинга плагина vk-photos

## Текущее состояние

### Структура проекта
```
vk-photos/
├── api/                    # VK API класс (нужно переместить в src)
│   └── vkapi.class.php
├── inc/                    # Основная логика (требует рефакторинга)
│   ├── class.main.php     # Монолитный класс ~1000 строк
│   └── next-page.php      # AJAX обработчик
├── src/                    # Начало современной архитектуры
│   ├── Bootstrap.php      # Инициализация плагина
│   └── Container.php      # DI контейнер (Illuminate Container)
├── templates/              # Шаблоны галереи
├── functions.php          # Вспомогательные функции
└── vk-photos.php         # Главный файл плагина
```

### Проблемы текущей архитектуры

1. **Монолитный класс `VkPhotos`** (~1000 строк):
   - Смешение ответственностей (SRP нарушен)
   - Админка, фронтенд, API, кеширование, рендеринг - все в одном классе
   - Сложно тестировать
   - Сложно поддерживать

2. **Отсутствие разделения слоев**:
   - Нет разделения на Service, Repository, Controller, View
   - Бизнес-логика смешана с представлением
   - Нет абстракций для работы с данными

3. **Устаревшие практики**:
   - Использование `extract()` для работы с массивами
   - Глобальные переменные
   - Прямые обращения к файловой системе без абстракций
   - Смешение логики и представления

4. **Структура директорий**:
   - `api/` должна быть внутри `src/`
   - `inc/` содержит устаревший код, который нужно рефакторить

## Цели рефакторинга

1. **Современная архитектура**:
   - Разделение на слои (Service Layer, Repository Pattern)
   - Dependency Injection через Container
   - PSR-4 автозагрузка
   - Разделение админки и фронтенда

2. **Улучшение поддерживаемости**:
   - Модульная структура
   - Единая ответственность классов (SRP)
   - Легко тестируемый код
   - Четкие интерфейсы

3. **Миграция существующего кода**:
   - Сохранение обратной совместимости
   - Постепенная миграция
   - Минимальные breaking changes

## Предлагаемая архитектура

### Структура директорий

```
src/
├── Api/                    # API клиенты
│   ├── VkApiClient.php    # Интерфейс VK API
│   └── VkApiClientImpl.php # Реализация (из api/vkapi.class.php)
│
├── Services/               # Бизнес-логика
│   ├── AlbumService.php   # Работа с альбомами
│   ├── PhotoService.php   # Работа с фотографиями
│   ├── CacheService.php   # Управление кешем
│   └── SettingsService.php # Работа с настройками
│
├── Repositories/          # Работа с данными
│   ├── AlbumRepository.php # Репозиторий альбомов
│   ├── PhotoRepository.php # Репозиторий фотографий
│   └── CacheRepository.php # Репозиторий кеша
│
├── Controllers/           # Обработка запросов
│   ├── ShortcodeController.php # Обработка шорткодов
│   ├── AjaxController.php # AJAX обработчики
│   └── Admin/             # Админ контроллеры
│       ├── SettingsController.php
│       ├── AlbumsController.php
│       └── CacheController.php
│
├── Models/                # Модели данных
│   ├── Album.php
│   ├── Photo.php
│   └── Settings.php
│
├── Views/                 # Представление
│   ├── GalleryRenderer.php # Рендеринг галереи
│   └── Admin/             # Админ представления
│       ├── SettingsView.php
│       └── AlbumsView.php
│
├── Helpers/               # Вспомогательные классы
│   ├── ImageHelper.php    # Работа с изображениями
│   ├── TemplateHelper.php # Работа с шаблонами
│   └── SizeHelper.php     # Работа с размерами
│
├── Hooks/                 # WordPress хуки
│   ├── AdminHooks.php
│   ├── FrontendHooks.php
│   └── ShortcodeHooks.php
│
├── Exceptions/            # Исключения
│   ├── VkApiException.php
│   └── CacheException.php
│
├── Bootstrap.php          # Инициализация (уже есть)
└── Container.php          # DI контейнер (уже есть)
```

### Архитектурные принципы

#### 1. Service Layer Pattern
- **Services** содержат бизнес-логику
- Не зависят от WordPress напрямую
- Легко тестируются

#### 2. Repository Pattern
- **Repositories** абстрагируют источники данных (VK API, кеш, БД)
- Позволяет легко менять источники данных
- Упрощает тестирование

#### 3. Dependency Injection
- Все зависимости через Container
- Интерфейсы для основных сервисов
- Легко мокать для тестов

#### 4. Separation of Concerns
- **Controllers** - обработка запросов
- **Services** - бизнес-логика
- **Repositories** - доступ к данным
- **Views** - представление
- **Models** - структуры данных

## Этапы миграции

### Этап 1: Подготовка инфраструктуры
- [x] Создать Container (уже есть)
- [x] Создать Bootstrap (уже есть)
- [ ] Создать базовые интерфейсы
- [ ] Настроить PSR-4 автозагрузку для всех классов

### Этап 2: Миграция API
- [ ] Переместить `api/vkapi.class.php` → `src/Api/VkApiClientImpl.php`
- [ ] Создать интерфейс `VkApiClientInterface`
- [ ] Обновить автозагрузку
- [ ] Зарегистрировать в Container

### Этап 3: Создание моделей и репозиториев
- [ ] Создать модели: `Album`, `Photo`, `Settings`
- [ ] Создать `AlbumRepository` с методами из VkPhotos
- [ ] Создать `PhotoRepository`
- [ ] Создать `CacheRepository`

### Этап 4: Создание сервисов
- [ ] `AlbumService` - логика работы с альбомами
- [ ] `PhotoService` - логика работы с фотографиями
- [ ] `CacheService` - логика кеширования
- [ ] `SettingsService` - работа с настройками

### Этап 5: Создание контроллеров
- [ ] `ShortcodeController` - обработка `[vkalbum]`
- [ ] `AjaxController` - обработка AJAX запросов (next-page.php)
- [ ] `Admin/SettingsController` - настройки плагина
- [ ] `Admin/AlbumsController` - список альбомов
- [ ] `Admin/CacheController` - управление кешем

### Этап 6: Создание представлений
- [ ] `GalleryRenderer` - рендеринг галереи
- [ ] `Admin/SettingsView` - страница настроек
- [ ] `Admin/AlbumsView` - страница альбомов
- [ ] Вынести логику шаблонов из контроллеров

### Этап 7: Создание хуков
- [ ] `ShortcodeHooks` - регистрация шорткодов
- [ ] `AdminHooks` - регистрация админ меню
- [ ] `FrontendHooks` - регистрация скриптов/стилей

### Этап 8: Рефакторинг основного класса
- [ ] Разбить `VkPhotos` на отдельные классы
- [ ] Перенести логику в соответствующие сервисы/контроллеры
- [ ] Обновить Bootstrap для использования новых классов
- [ ] Сохранить обратную совместимость (если нужно)

### Этап 9: Очистка
- [ ] Удалить старый код из `inc/`
- [ ] Удалить `api/` (после миграции)
- [ ] Обновить `functions.php` (оставить только вспомогательные функции)
- [ ] Обновить документацию

## Детальная структура классов

### Api Layer

#### `VkApiClientInterface`
```php
interface VkApiClientInterface {
    public function api(string $method, array $params = []): array;
    public function getAlbums(int $ownerId): array;
    public function getPhotos(int $ownerId, int $albumId): array;
}
```

#### `VkApiClientImpl`
- Реализация интерфейса
- Обертка над существующим `vkapi` классом
- Обработка ошибок API
- Нормализация ответов

### Services Layer

#### `AlbumService`
- Получение альбомов пользователя/группы
- Валидация параметров альбома
- Работа с метаданными альбома

#### `PhotoService`
- Получение фотографий из альбома
- Обработка размеров изображений
- Нормализация данных фотографий

#### `CacheService`
- Создание кеша альбомов
- Проверка актуальности кеша
- Удаление кеша
- Подсчет размера кеша

#### `SettingsService`
- Получение настроек плагина
- Сохранение настроек
- Валидация настроек
- Значения по умолчанию

### Repositories Layer

#### `AlbumRepository`
- `getAlbums(int $ownerId): array` - получение альбомов
- `getAlbum(int $ownerId, int $albumId): ?Album` - получение альбома
- Работа с VK API через `VkApiClient`

#### `PhotoRepository`
- `getPhotos(int $ownerId, int $albumId): array` - получение фотографий
- `getPhoto(int $photoId): ?Photo` - получение фотографии
- Работа с VK API через `VkApiClient`

#### `CacheRepository`
- `getCachedAlbum(int $ownerId, int $albumId): ?array` - получение из кеша
- `saveAlbumCache(int $ownerId, int $albumId, array $data): bool` - сохранение
- `deleteAlbumCache(int $ownerId, int $albumId): bool` - удаление
- `isCacheValid(int $ownerId, int $albumId): bool` - проверка актуальности

### Controllers Layer

#### `ShortcodeController`
- Обработка атрибутов шорткода `[vkalbum]`
- Вызов сервисов для получения данных
- Вызов рендерера для отображения

#### `AjaxController`
- Обработка AJAX запроса `next-page`
- Пагинация фотографий
- Возврат HTML для вставки

#### `Admin/SettingsController`
- Отображение страницы настроек
- Обработка сохранения настроек
- Валидация данных

#### `Admin/AlbumsController`
- Отображение списка альбомов
- Получение альбомов из VK
- Отображение шорткодов

#### `Admin/CacheController`
- Отображение кешированных альбомов
- Удаление кеша
- Подсчет размера кеша

### Views Layer

#### `GalleryRenderer`
- Рендеринг галереи по шаблону
- Подстановка данных в шаблоны
- Генерация JavaScript для пагинации
- Подключение viewer'ов (colorbox, swipebox)

#### `Admin/SettingsView`
- Форма настроек
- Валидация полей
- Отображение ошибок

#### `Admin/AlbumsView`
- Таблица альбомов
- Форматирование данных
- Ссылки на VK

### Helpers Layer

#### `ImageHelper`
- Обработка изображений
- Создание миниатюр
- Кроп изображений (метод `image_crop`)

#### `TemplateHelper`
- Загрузка шаблонов
- Подстановка переменных в шаблоны
- Обработка плейсхолдеров

#### `SizeHelper`
- Конвертация размеров (trPictureSize)
- Получение размера фотографии (get_photo_size)
- Нормализация размеров

## Интеграция с WordPress

### Регистрация хуков
- Все хуки в отдельных классах `Hooks/*`
- Регистрация через Bootstrap
- Использование Container для получения зависимостей

### Шорткоды
- Регистрация через `ShortcodeHooks`
- Обработка через `ShortcodeController`

### AJAX
- Регистрация через WordPress AJAX API
- Обработка через `AjaxController`
- Использование nonce для безопасности

### Админка
- Регистрация меню через `AdminHooks`
- Страницы через контроллеры
- Использование WordPress Settings API

## Обратная совместимость

1. **Шорткод `[vkalbum]`** - должен работать как раньше
2. **Настройки плагина** - должны сохраняться в тех же опциях
3. **Кеш** - должен использовать ту же структуру директорий
4. **Шаблоны** - должны работать без изменений

## Тестирование

После рефакторинга код должен быть легко тестируемым:
- Unit тесты для Services
- Integration тесты для Repositories
- Mock'и для VK API
- Тесты для контроллеров

## Преимущества новой архитектуры

1. **Модульность** - каждый класс имеет одну ответственность
2. **Тестируемость** - легко писать unit тесты
3. **Расширяемость** - легко добавлять новые функции
4. **Поддерживаемость** - понятная структура кода
5. **Переиспользование** - сервисы можно использовать в разных местах
6. **Гибкость** - легко менять реализации через интерфейсы

## Риски и митигация

### Риск: Breaking changes
**Митигация**: Сохранить обратную совместимость, постепенная миграция

### Риск: Сложность миграции большого кода
**Митигация**: Поэтапная миграция, тестирование на каждом этапе

### Риск: Производительность
**Митигация**: Использование singleton для тяжелых объектов, кеширование

## Временные рамки

- **Этап 1-2**: 1-2 дня (инфраструктура + API)
- **Этап 3-4**: 2-3 дня (модели, репозитории, сервисы)
- **Этап 5-6**: 2-3 дня (контроллеры, представления)
- **Этап 7-8**: 2-3 дня (хуки, рефакторинг основного класса)
- **Этап 9**: 1 день (очистка)

**Итого**: ~10-12 дней работы

## Следующие шаги

1. Создать базовые интерфейсы
2. Начать с миграции API класса
3. Постепенно переносить функциональность
4. Тестировать на каждом этапе
5. Документировать изменения
